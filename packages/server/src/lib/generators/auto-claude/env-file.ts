import { AutoClaudeProjectConfig, CustomMcpServer } from '../../../../../shared/src/types/auto-claude';
import { timeOperationSync } from '../../performance-monitor';

interface EnvFileOptions {
  projectConfig?: AutoClaudeProjectConfig | null;
  settings?: Record<string, string>;
}

/**
 * Generates .auto-claude/.env file with MCP toggles, API keys, and custom servers - optimized version
 */
export function generateAutoClaudeEnv(options: EnvFileOptions): string {
  const { result } = timeOperationSync('env-file generation', () => {
    const { projectConfig, settings = {} } = options;

    // Use StringBuilder approach for better performance with large configs
    const parts: string[] = [];

    // Pre-compute common values to avoid repeated computations
    const hasCustomServers = projectConfig?.customMcpServers && projectConfig.customMcpServers.length > 0;
    const hasAgentOverrides = projectConfig?.agentMcpOverrides && Object.keys(projectConfig.agentMcpOverrides).length > 0;
    const isEnabled = projectConfig !== null && projectConfig !== undefined;

    // Optimized section builder using direct string concatenation
    const addSection = (title: string, content: string[]): void => {
      parts.push(`# === ${title} ===`);
      parts.push(...content);
      parts.push('');
    };

    // Header comment
    addSection('Auto-Claude Environment Configuration', [
      '# Generated by Claude Code Config Manager',
      '# Do not edit manually - sync from CCM to update'
    ]);

    // Core Auto-Claude settings
    addSection('Core Auto-Claude Settings', [
      '# Auto-Claude backend integration',
      `AUTO_CLAUDE_ENABLED=${isEnabled ? 'true' : 'false'}`
    ]);

    // API Keys section - optimize by pre-computing values
    const apiKeyValues = {
      anthropic: settings.anthropicApiKey || '',
      linear: settings.linearApiKey || projectConfig?.linearApiKey || '',
      github: settings.githubToken || projectConfig?.githubToken || '',
      graphiti: settings.graphitiApiKey || ''
    };

    addSection('API Keys', [
      '# Anthropic API key for Claude models',
      `ANTHROPIC_API_KEY=${apiKeyValues.anthropic}`
    ]);

    // Integration API keys - build efficiently using template literals
    const integrationLines: string[] = [];

    // Linear integration
    integrationLines.push('# Linear integration', `LINEAR_API_KEY=${apiKeyValues.linear}`);
    if (projectConfig?.linearTeamId) {
      integrationLines.push(`LINEAR_TEAM_ID=${projectConfig.linearTeamId}`);
    }

    integrationLines.push('', '# GitHub integration', `GITHUB_TOKEN=${apiKeyValues.github}`);
    if (projectConfig?.githubRepo) {
      integrationLines.push(`GITHUB_REPO=${projectConfig.githubRepo}`);
    }

    integrationLines.push('', '# Graphiti integration', `GRAPHITI_API_KEY=${apiKeyValues.graphiti}`);

    addSection('Integration API Keys', integrationLines);

    if (projectConfig) {
      // MCP Server toggles using optimized string building
      addSection('MCP Server Configuration', [
        '# Enable/disable specific MCP servers',
        `CONTEXT7_ENABLED=${projectConfig.context7Enabled}`,
        `LINEAR_MCP_ENABLED=${projectConfig.linearMcpEnabled}`,
        `ELECTRON_MCP_ENABLED=${projectConfig.electronMcpEnabled}`,
        `PUPPETEER_MCP_ENABLED=${projectConfig.puppeteerMcpEnabled}`,
        `GRAPHITI_ENABLED=${projectConfig.graphitiEnabled}`
      ]);

      // Custom MCP servers - optimized loop with minimal string concatenation
      if (hasCustomServers) {
        const customServerLines = ['# Custom MCP server definitions'];

        for (const server of projectConfig.customMcpServers!) {
          const serverIdUpper = server.id.toUpperCase();
          customServerLines.push(
            `# ${server.name} (${server.type})`,
            `CUSTOM_MCP_${serverIdUpper}_TYPE=${server.type}`
          );

          if (server.type === 'command' && server.command) {
            customServerLines.push(`CUSTOM_MCP_${serverIdUpper}_COMMAND=${server.command}`);
            if (server.args?.length) {
              customServerLines.push(`CUSTOM_MCP_${serverIdUpper}_ARGS=${server.args.join(' ')}`);
            }
          }

          if (server.type === 'http' && server.url) {
            customServerLines.push(`CUSTOM_MCP_${serverIdUpper}_URL=${server.url}`);
            if (server.headers && Object.keys(server.headers).length > 0) {
              const headerStr = Object.entries(server.headers)
                .map(([key, value]) => `${key}:${value}`)
                .join(',');
              customServerLines.push(`CUSTOM_MCP_${serverIdUpper}_HEADERS=${headerStr}`);
            }
          }

          customServerLines.push('');
        }

        addSection('Custom MCP Servers', customServerLines);
      }

      // Agent MCP overrides - optimized iteration
      if (hasAgentOverrides) {
        const overrideLines = ['# Per-agent MCP server additions and removals'];

        for (const [agentType, override] of Object.entries(projectConfig.agentMcpOverrides!)) {
          const agentTypeUpper = agentType.toUpperCase();
          if (override.add?.length) {
            overrideLines.push(`AGENT_${agentTypeUpper}_MCP_ADD=${override.add.join(',')}`);
          }
          if (override.remove?.length) {
            overrideLines.push(`AGENT_${agentTypeUpper}_MCP_REMOVE=${override.remove.join(',')}`);
          }
        }

        addSection('Agent MCP Overrides', overrideLines);
      }
    } else {
      // Default disabled state when no project config
      addSection('MCP Server Configuration', [
        '# MCP servers disabled - no project configuration found',
        'CONTEXT7_ENABLED=false',
        'LINEAR_MCP_ENABLED=false',
        'ELECTRON_MCP_ENABLED=false',
        'PUPPETEER_MCP_ENABLED=false',
        'GRAPHITI_ENABLED=false'
      ]);
    }

    // Development settings
    addSection('Development Settings', [
      '# Debug and development configuration',
      'AUTO_CLAUDE_DEBUG=false',
      'AUTO_CLAUDE_LOG_LEVEL=info'
    ]);

    // Optimized join with single allocation
    return parts.join('\n') + '\n';
  }, 1); // 1 file generated

  return result;
}

/**
 * Helper function to validate environment variables for Auto-Claude
 */
export function validateAutoClaudeEnv(envContent: string): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  const lines = envContent.split('\n');
  const envVars: Record<string, string> = {};

  // Parse env variables
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const [key, ...valueParts] = trimmed.split('=');
      if (key && valueParts.length > 0) {
        envVars[key] = valueParts.join('=');
      }
    }
  }

  // Validate required variables
  if (!envVars.ANTHROPIC_API_KEY || envVars.ANTHROPIC_API_KEY === '') {
    errors.push('ANTHROPIC_API_KEY is required but not set');
  }

  if (envVars.AUTO_CLAUDE_ENABLED === 'true') {
    // Check for at least one MCP server enabled
    const mcpEnabled = [
      envVars.CONTEXT7_ENABLED === 'true',
      envVars.LINEAR_MCP_ENABLED === 'true',
      envVars.ELECTRON_MCP_ENABLED === 'true',
      envVars.PUPPETEER_MCP_ENABLED === 'true',
      envVars.GRAPHITI_ENABLED === 'true'
    ].some(Boolean);

    if (!mcpEnabled) {
      errors.push('At least one MCP server should be enabled when AUTO_CLAUDE_ENABLED is true');
    }

    // Validate Linear integration if enabled
    if (envVars.LINEAR_MCP_ENABLED === 'true' && !envVars.LINEAR_API_KEY) {
      errors.push('LINEAR_API_KEY is required when LINEAR_MCP_ENABLED is true');
    }

    // Validate GitHub integration if GitHub token is present
    if (envVars.GITHUB_TOKEN && !envVars.GITHUB_REPO) {
      errors.push('GITHUB_REPO should be specified when GITHUB_TOKEN is present');
    }

    // Validate Graphiti integration if enabled
    if (envVars.GRAPHITI_ENABLED === 'true' && !envVars.GRAPHITI_API_KEY) {
      errors.push('GRAPHITI_API_KEY is required when GRAPHITI_ENABLED is true');
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

/**
 * Helper function to get default Auto-Claude project configuration
 */
export function getDefaultAutoClaudeProjectConfig(): AutoClaudeProjectConfig {
  return {
    context7Enabled: true,
    linearMcpEnabled: false,
    electronMcpEnabled: false,
    puppeteerMcpEnabled: false,
    graphitiEnabled: false,
    customMcpServers: [],
    agentMcpOverrides: {}
  };
}