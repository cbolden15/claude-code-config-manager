import { AutoClaudeProjectConfig, CustomMcpServer } from '../../../../../shared/src/types/auto-claude';

interface EnvFileOptions {
  projectConfig?: AutoClaudeProjectConfig | null;
  settings?: Record<string, string>;
}

/**
 * Generates .auto-claude/.env file with MCP toggles, API keys, and custom servers
 */
export function generateAutoClaudeEnv(options: EnvFileOptions): string {
  const performanceStart = performance.now();
  const { projectConfig, settings = {} } = options;
  const lines: string[] = [];

  // Header comment
  lines.push('# Auto-Claude Environment Configuration');
  lines.push('# Generated by Claude Code Config Manager');
  lines.push('# Do not edit manually - sync from CCM to update');
  lines.push('');

  // Core Auto-Claude settings
  lines.push('# === Core Auto-Claude Settings ===');
  lines.push('# Auto-Claude backend integration');
  lines.push(`AUTO_CLAUDE_ENABLED=${projectConfig ? 'true' : 'false'}`);
  lines.push('');

  // API Keys section
  lines.push('# === API Keys ===');
  lines.push('# Anthropic API key for Claude models');
  const anthropicKey = settings.anthropicApiKey || '';
  lines.push(`ANTHROPIC_API_KEY=${anthropicKey}`);
  lines.push('');

  // Integration API keys
  lines.push('# === Integration API Keys ===');
  const linearApiKey = settings.linearApiKey || projectConfig?.linearApiKey || '';
  const githubToken = settings.githubToken || projectConfig?.githubToken || '';
  const graphitiApiKey = settings.graphitiApiKey || '';

  lines.push('# Linear integration');
  lines.push(`LINEAR_API_KEY=${linearApiKey}`);
  if (projectConfig?.linearTeamId) {
    lines.push(`LINEAR_TEAM_ID=${projectConfig.linearTeamId}`);
  }
  lines.push('');

  lines.push('# GitHub integration');
  lines.push(`GITHUB_TOKEN=${githubToken}`);
  if (projectConfig?.githubRepo) {
    lines.push(`GITHUB_REPO=${projectConfig.githubRepo}`);
  }
  lines.push('');

  lines.push('# Graphiti integration');
  lines.push(`GRAPHITI_API_KEY=${graphitiApiKey}`);
  lines.push('');

  if (projectConfig) {
    // MCP Server toggles
    lines.push('# === MCP Server Configuration ===');
    lines.push('# Enable/disable specific MCP servers');
    lines.push(`CONTEXT7_ENABLED=${projectConfig.context7Enabled ? 'true' : 'false'}`);
    lines.push(`LINEAR_MCP_ENABLED=${projectConfig.linearMcpEnabled ? 'true' : 'false'}`);
    lines.push(`ELECTRON_MCP_ENABLED=${projectConfig.electronMcpEnabled ? 'true' : 'false'}`);
    lines.push(`PUPPETEER_MCP_ENABLED=${projectConfig.puppeteerMcpEnabled ? 'true' : 'false'}`);
    lines.push(`GRAPHITI_ENABLED=${projectConfig.graphitiEnabled ? 'true' : 'false'}`);
    lines.push('');

    // Custom MCP servers
    if (projectConfig.customMcpServers && projectConfig.customMcpServers.length > 0) {
      lines.push('# === Custom MCP Servers ===');
      lines.push('# Custom MCP server definitions');

      for (const server of projectConfig.customMcpServers) {
        lines.push(`# ${server.name} (${server.type})`);
        lines.push(`CUSTOM_MCP_${server.id.toUpperCase()}_TYPE=${server.type}`);

        if (server.type === 'command' && server.command) {
          lines.push(`CUSTOM_MCP_${server.id.toUpperCase()}_COMMAND=${server.command}`);
          if (server.args && server.args.length > 0) {
            lines.push(`CUSTOM_MCP_${server.id.toUpperCase()}_ARGS=${server.args.join(' ')}`);
          }
        }

        if (server.type === 'http' && server.url) {
          lines.push(`CUSTOM_MCP_${server.id.toUpperCase()}_URL=${server.url}`);
          if (server.headers) {
            const headerStr = Object.entries(server.headers)
              .map(([key, value]) => `${key}:${value}`)
              .join(',');
            lines.push(`CUSTOM_MCP_${server.id.toUpperCase()}_HEADERS=${headerStr}`);
          }
        }

        lines.push('');
      }
    }

    // Agent MCP overrides
    if (projectConfig.agentMcpOverrides && Object.keys(projectConfig.agentMcpOverrides).length > 0) {
      lines.push('# === Agent MCP Overrides ===');
      lines.push('# Per-agent MCP server additions and removals');

      for (const [agentType, override] of Object.entries(projectConfig.agentMcpOverrides)) {
        if (override.add && override.add.length > 0) {
          lines.push(`AGENT_${agentType.toUpperCase()}_MCP_ADD=${override.add.join(',')}`);
        }
        if (override.remove && override.remove.length > 0) {
          lines.push(`AGENT_${agentType.toUpperCase()}_MCP_REMOVE=${override.remove.join(',')}`);
        }
      }
      lines.push('');
    }
  } else {
    // Default disabled state when no project config
    lines.push('# === MCP Server Configuration ===');
    lines.push('# MCP servers disabled - no project configuration found');
    lines.push('CONTEXT7_ENABLED=false');
    lines.push('LINEAR_MCP_ENABLED=false');
    lines.push('ELECTRON_MCP_ENABLED=false');
    lines.push('PUPPETEER_MCP_ENABLED=false');
    lines.push('GRAPHITI_ENABLED=false');
    lines.push('');
  }

  // Development settings
  lines.push('# === Development Settings ===');
  lines.push('# Debug and development configuration');
  lines.push('AUTO_CLAUDE_DEBUG=false');
  lines.push('AUTO_CLAUDE_LOG_LEVEL=info');
  lines.push('');

  // Add performance logging
  const performanceEnd = performance.now();
  console.log(`[PERF] Env file generation: ${Math.round(performanceEnd - performanceStart)}ms`);

  // End with a final newline
  return lines.join('\n');
}

/**
 * Helper function to validate environment variables for Auto-Claude
 */
export function validateAutoClaudeEnv(envContent: string): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  const lines = envContent.split('\n');
  const envVars: Record<string, string> = {};

  // Parse env variables
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const [key, ...valueParts] = trimmed.split('=');
      if (key && valueParts.length > 0) {
        envVars[key] = valueParts.join('=');
      }
    }
  }

  // Validate required variables
  if (!envVars.ANTHROPIC_API_KEY || envVars.ANTHROPIC_API_KEY === '') {
    errors.push('ANTHROPIC_API_KEY is required but not set');
  }

  if (envVars.AUTO_CLAUDE_ENABLED === 'true') {
    // Check for at least one MCP server enabled
    const mcpEnabled = [
      envVars.CONTEXT7_ENABLED === 'true',
      envVars.LINEAR_MCP_ENABLED === 'true',
      envVars.ELECTRON_MCP_ENABLED === 'true',
      envVars.PUPPETEER_MCP_ENABLED === 'true',
      envVars.GRAPHITI_ENABLED === 'true'
    ].some(Boolean);

    if (!mcpEnabled) {
      errors.push('At least one MCP server should be enabled when AUTO_CLAUDE_ENABLED is true');
    }

    // Validate Linear integration if enabled
    if (envVars.LINEAR_MCP_ENABLED === 'true' && !envVars.LINEAR_API_KEY) {
      errors.push('LINEAR_API_KEY is required when LINEAR_MCP_ENABLED is true');
    }

    // Validate GitHub integration if GitHub token is present
    if (envVars.GITHUB_TOKEN && !envVars.GITHUB_REPO) {
      errors.push('GITHUB_REPO should be specified when GITHUB_TOKEN is present');
    }

    // Validate Graphiti integration if enabled
    if (envVars.GRAPHITI_ENABLED === 'true' && !envVars.GRAPHITI_API_KEY) {
      errors.push('GRAPHITI_API_KEY is required when GRAPHITI_ENABLED is true');
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

/**
 * Helper function to get default Auto-Claude project configuration
 */
export function getDefaultAutoClaudeProjectConfig(): AutoClaudeProjectConfig {
  return {
    context7Enabled: true,
    linearMcpEnabled: false,
    electronMcpEnabled: false,
    puppeteerMcpEnabled: false,
    graphitiEnabled: false,
    customMcpServers: [],
    agentMcpOverrides: {}
  };
}