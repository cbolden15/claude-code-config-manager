#!/usr/bin/env node
import assert from 'node:assert';
import {
  generateAutoClaudePrompts,
  validatePromptContent,
  validatePrompts,
  getDefaultInjectionContext,
  extractInjectionPoints
} from '../../../src/lib/generators/auto-claude/prompts.js';

// Test utilities
function assertStringContains(str: string, substring: string, message?: string) {
  assert(str.includes(substring), message || `Expected string to contain "${substring}"`);
}

function assertStringNotContains(str: string, substring: string, message?: string) {
  assert(!str.includes(substring), message || `Expected string not to contain "${substring}"`);
}

function runTests() {
  console.log('ðŸ§ª Testing prompts generator...\n');

  // Test 1: Basic prompt generation without injection points
  (() => {
    console.log('Test 1: Basic prompt generation without injection points');
    const prompts = [
      {
        agentType: 'coder',
        promptContent: 'You are a skilled software engineer.',
        injectionPoints: {}
      }
    ];

    const result = generateAutoClaudePrompts({ prompts });

    assert.strictEqual(result.length, 1);
    assert.strictEqual(result[0].path, 'prompts/coder.md');
    assertStringContains(result[0].content, 'You are a skilled software engineer.');
    assertStringContains(result[0].content, '<!-- Generated by Claude Code Config Manager -->');
    assertStringContains(result[0].content, '<!-- Do not edit manually - sync from CCM to update -->');

    console.log('âœ… Basic prompt generation test passed\n');
  })();

  // Test 2: Prompt generation with injection points
  (() => {
    console.log('Test 2: Prompt generation with injection points');
    const prompts = [
      {
        agentType: 'spec_gatherer',
        promptContent: `# Specification Gatherer

You will analyze the project in {{specDirectory}} with context from {{projectContext}}.

Use MCP tools: {{mcpDocumentation}}`,
        injectionPoints: {
          specDirectory: true,
          projectContext: true,
          mcpDocumentation: true
        }
      }
    ];

    const injectionContext = {
      specDirectory: './.auto-claude/specs/test-spec',
      projectContext: 'Test project context',
      mcpDocumentation: 'Test MCP docs'
    };

    const result = generateAutoClaudePrompts({ prompts, injectionContext });

    assert.strictEqual(result.length, 1);
    assertStringContains(result[0].content, './.auto-claude/specs/test-spec');
    assertStringContains(result[0].content, 'Test project context');
    assertStringContains(result[0].content, 'Test MCP docs');
    assertStringNotContains(result[0].content, '{{specDirectory}}');
    assertStringNotContains(result[0].content, '{{projectContext}}');
    assertStringNotContains(result[0].content, '{{mcpDocumentation}}');

    console.log('âœ… Injection points replacement test passed\n');
  })();

  // Test 3: Prompt generation with partial injection context
  (() => {
    console.log('Test 3: Prompt generation with partial injection context');
    const prompts = [
      {
        agentType: 'planner',
        promptContent: `Planning agent with spec {{specDirectory}} and context {{projectContext}} and docs {{mcpDocumentation}}`,
        injectionPoints: {
          specDirectory: true,
          projectContext: false,
          mcpDocumentation: true
        }
      }
    ];

    const injectionContext = {
      specDirectory: './test-spec',
      // projectContext not provided
      mcpDocumentation: 'Test docs'
    };

    const result = generateAutoClaudePrompts({ prompts, injectionContext });

    assertStringContains(result[0].content, './test-spec');
    assertStringContains(result[0].content, '<!-- Injection point not resolved -->');
    assertStringContains(result[0].content, 'Test docs');
    assertStringNotContains(result[0].content, '{{specDirectory}}');
    assertStringNotContains(result[0].content, '{{mcpDocumentation}}');

    console.log('âœ… Partial injection context test passed\n');
  })();

  // Test 4: Prompt generation with front matter
  (() => {
    console.log('Test 4: Prompt generation with front matter');
    const prompts = [
      {
        agentType: 'qa_reviewer',
        promptContent: `---
title: QA Reviewer
version: 1.0
---

# QA Reviewer

You are a quality assurance specialist.`,
        injectionPoints: {}
      }
    ];

    const result = generateAutoClaudePrompts({ prompts });

    const lines = result[0].content.split('\n');
    assert.strictEqual(lines[0], '---');
    assert(lines.includes('title: QA Reviewer'));
    assert(lines.includes('version: 1.0'));
    assert(lines.includes('---'));

    // Check that generated comment is after front matter
    const frontMatterEnd = lines.findIndex((line, index) =>
      index > 0 && line.trim() === '---'
    );
    const generatedCommentIndex = lines.findIndex(line =>
      line.includes('Generated by Claude Code Config Manager')
    );
    assert(generatedCommentIndex > frontMatterEnd);

    console.log('âœ… Front matter preservation test passed\n');
  })();

  // Test 5: Multiple prompts generation
  (() => {
    console.log('Test 5: Multiple prompts generation');
    const prompts = [
      {
        agentType: 'coder',
        promptContent: 'Coder prompt',
        injectionPoints: {}
      },
      {
        agentType: 'planner',
        promptContent: 'Planner prompt with {{specDirectory}}',
        injectionPoints: { specDirectory: true }
      },
      {
        agentType: 'qa_reviewer',
        promptContent: 'QA reviewer prompt',
        injectionPoints: {}
      }
    ];

    const injectionContext = {
      specDirectory: './test-spec'
    };

    const result = generateAutoClaudePrompts({ prompts, injectionContext });

    assert.strictEqual(result.length, 3);
    assert.strictEqual(result[0].path, 'prompts/coder.md');
    assert.strictEqual(result[1].path, 'prompts/planner.md');
    assert.strictEqual(result[2].path, 'prompts/qa_reviewer.md');

    assertStringContains(result[0].content, 'Coder prompt');
    assertStringContains(result[1].content, './test-spec');
    assertStringContains(result[2].content, 'QA reviewer prompt');

    console.log('âœ… Multiple prompts generation test passed\n');
  })();

  // Test 6: Validate valid prompt content
  (() => {
    console.log('Test 6: Validate valid prompt content');
    const prompt = {
      agentType: 'test_agent',
      promptContent: 'Valid prompt content with {{specDirectory}} injection.',
      injectionPoints: {
        specDirectory: true,
        projectContext: false,
        mcpDocumentation: false
      }
    };

    const validation = validatePromptContent(prompt);
    assert(validation.valid, `Expected valid prompt but got errors: ${validation.errors.join(', ')}`);
    assert.strictEqual(validation.errors.length, 0);

    console.log('âœ… Valid prompt validation test passed\n');
  })();

  // Test 7: Validate invalid prompt - missing agent type
  (() => {
    console.log('Test 7: Validate invalid prompt - missing agent type');
    const prompt = {
      agentType: '',
      promptContent: 'Valid content',
      injectionPoints: {}
    };

    const validation = validatePromptContent(prompt);
    assert(!validation.valid, 'Expected invalid prompt');
    assert(validation.errors.some(e => e.includes('Agent type is required')));

    console.log('âœ… Missing agent type validation test passed\n');
  })();

  // Test 8: Validate invalid prompt - missing content
  (() => {
    console.log('Test 8: Validate invalid prompt - missing content');
    const prompt = {
      agentType: 'test_agent',
      promptContent: '',
      injectionPoints: {}
    };

    const validation = validatePromptContent(prompt);
    assert(!validation.valid, 'Expected invalid prompt');
    assert(validation.errors.some(e => e.includes('Prompt content is required')));

    console.log('âœ… Missing content validation test passed\n');
  })();

  // Test 9: Validate invalid agent type format
  (() => {
    console.log('Test 9: Validate invalid agent type format');
    const prompt = {
      agentType: 'invalid-agent-type!',
      promptContent: 'Valid content',
      injectionPoints: {}
    };

    const validation = validatePromptContent(prompt);
    assert(!validation.valid, 'Expected invalid prompt');
    assert(validation.errors.some(e => e.includes('alphanumeric with underscores only')));

    console.log('âœ… Invalid agent type format validation test passed\n');
  })();

  // Test 10: Validate injection point mismatch - undeclared in content
  (() => {
    console.log('Test 10: Validate injection point mismatch - undeclared');
    const prompt = {
      agentType: 'test_agent',
      promptContent: 'Content with {{undeclaredPoint}} and {{specDirectory}}',
      injectionPoints: {
        specDirectory: true
      }
    };

    const validation = validatePromptContent(prompt);
    assert(!validation.valid, 'Expected invalid prompt');
    assert(validation.errors.some(e => e.includes('undeclaredPoint\' found in content but not declared')));

    console.log('âœ… Undeclared injection point validation test passed\n');
  })();

  // Test 11: Validate injection point mismatch - declared but not in content
  (() => {
    console.log('Test 11: Validate injection point mismatch - declared but not in content');
    const prompt = {
      agentType: 'test_agent',
      promptContent: 'Content without injection points',
      injectionPoints: {
        specDirectory: true,
        projectContext: true
      }
    };

    const validation = validatePromptContent(prompt);
    assert(!validation.valid, 'Expected invalid prompt');
    assert(validation.errors.some(e => e.includes('specDirectory\' declared but not found')));
    assert(validation.errors.some(e => e.includes('projectContext\' declared but not found')));

    console.log('âœ… Declared but not found injection point validation test passed\n');
  })();

  // Test 12: Validate prompts array with duplicates
  (() => {
    console.log('Test 12: Validate prompts array with duplicates');
    const prompts = [
      {
        agentType: 'coder',
        promptContent: 'First coder prompt',
        injectionPoints: {}
      },
      {
        agentType: 'coder',
        promptContent: 'Duplicate coder prompt',
        injectionPoints: {}
      }
    ];

    const validation = validatePrompts(prompts);
    assert(!validation.valid, 'Expected invalid prompts array');
    assert(validation.errors.some(e => e.includes('Duplicate agent type \'coder\'')));

    console.log('âœ… Duplicate agent types validation test passed\n');
  })();

  // Test 13: Get default injection context
  (() => {
    console.log('Test 13: Get default injection context');
    const defaultContext = getDefaultInjectionContext();

    assert(defaultContext.specDirectory);
    assert(defaultContext.projectContext);
    assert(defaultContext.mcpDocumentation);
    assertStringContains(defaultContext.specDirectory, '.auto-claude/specs');
    assertStringContains(defaultContext.projectContext, 'Project Analysis');
    assertStringContains(defaultContext.mcpDocumentation, 'MCP Server Documentation');

    console.log('âœ… Default injection context test passed\n');
  })();

  // Test 14: Extract injection points from content
  (() => {
    console.log('Test 14: Extract injection points from content');
    const content = `
# Test Prompt

This uses {{specDirectory}} and {{projectContext}}.
Also uses {{mcpDocumentation}} and {{specDirectory}} again.
No injection here.
`;

    const points = extractInjectionPoints(content);
    assert.strictEqual(points.length, 3);
    assert(points.includes('specDirectory'));
    assert(points.includes('projectContext'));
    assert(points.includes('mcpDocumentation'));

    console.log('âœ… Extract injection points test passed\n');
  })();

  // Test 15: Extract injection points with no points
  (() => {
    console.log('Test 15: Extract injection points with no points');
    const content = `
# Simple Prompt

This has no injection points.
`;

    const points = extractInjectionPoints(content);
    assert.strictEqual(points.length, 0);

    console.log('âœ… No injection points extraction test passed\n');
  })();

  // Test 16: Edge case - empty prompts array
  (() => {
    console.log('Test 16: Edge case - empty prompts array');
    const result = generateAutoClaudePrompts({ prompts: [] });

    assert.strictEqual(result.length, 0);

    const validation = validatePrompts([]);
    assert(validation.valid);
    assert.strictEqual(validation.errors.length, 0);

    console.log('âœ… Empty prompts array test passed\n');
  })();

  // Test 17: Edge case - no injection context provided
  (() => {
    console.log('Test 17: Edge case - no injection context provided');
    const prompts = [
      {
        agentType: 'test_agent',
        promptContent: 'Content with {{specDirectory}}',
        injectionPoints: {
          specDirectory: true
        }
      }
    ];

    const result = generateAutoClaudePrompts({ prompts });

    assertStringContains(result[0].content, '<!-- Injection point not resolved -->');
    assertStringNotContains(result[0].content, '{{specDirectory}}');

    console.log('âœ… No injection context provided test passed\n');
  })();

  // Test 18: Complex injection points with special characters
  (() => {
    console.log('Test 18: Complex injection points with special characters');
    const content = `
{{normal_point}}
{{point-with-dashes}}
{{point.with.dots}}
{{UPPERCASE_POINT}}
{{123numbers}}
`;

    const points = extractInjectionPoints(content);
    assert.strictEqual(points.length, 5);
    assert(points.includes('normal_point'));
    assert(points.includes('point-with-dashes'));
    assert(points.includes('point.with.dots'));
    assert(points.includes('UPPERCASE_POINT'));
    assert(points.includes('123numbers'));

    console.log('âœ… Complex injection points test passed\n');
  })();

  console.log('ðŸŽ‰ All prompts generator tests passed!\n');
}

// Run tests if this file is executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  runTests();
}

export { runTests as runPromptsTests };