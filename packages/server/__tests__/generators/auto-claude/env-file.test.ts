#!/usr/bin/env node
import assert from 'node:assert';
import {
  generateAutoClaudeEnv,
  validateAutoClaudeEnv,
  getDefaultAutoClaudeProjectConfig
} from '../../../src/lib/generators/auto-claude/env-file.ts';

// Test utilities
function assertStringContains(str: string, substring: string, message?: string) {
  assert(str.includes(substring), message || `Expected string to contain "${substring}"`);
}

function assertStringNotContains(str: string, substring: string, message?: string) {
  assert(!str.includes(substring), message || `Expected string not to contain "${substring}"`);
}

function runTests() {
  console.log('ðŸ§ª Testing env-file generator...\n');

  // Test 1: Basic env generation with no config
  (() => {
    console.log('Test 1: Basic env generation with no config');
    const result = generateAutoClaudeEnv({});

    assertStringContains(result, '# Auto-Claude Environment Configuration');
    assertStringContains(result, '# Generated by Claude Code Config Manager');
    assertStringContains(result, 'AUTO_CLAUDE_ENABLED=false');
    assertStringContains(result, 'ANTHROPIC_API_KEY=');
    assertStringContains(result, 'CONTEXT7_ENABLED=false');
    assertStringContains(result, 'LINEAR_MCP_ENABLED=false');
    assertStringContains(result, 'ELECTRON_MCP_ENABLED=false');
    assertStringContains(result, 'PUPPETEER_MCP_ENABLED=false');
    assertStringContains(result, 'GRAPHITI_ENABLED=false');
    assertStringContains(result, '# MCP servers disabled - no project configuration found');

    console.log('âœ… Basic env generation test passed\n');
  })();

  // Test 2: Env generation with default project config
  (() => {
    console.log('Test 2: Env generation with default project config');
    const defaultConfig = getDefaultAutoClaudeProjectConfig();
    const result = generateAutoClaudeEnv({ projectConfig: defaultConfig });

    assertStringContains(result, 'AUTO_CLAUDE_ENABLED=true');
    assertStringContains(result, 'CONTEXT7_ENABLED=true');
    assertStringContains(result, 'LINEAR_MCP_ENABLED=false');
    assertStringContains(result, 'ELECTRON_MCP_ENABLED=false');
    assertStringContains(result, 'PUPPETEER_MCP_ENABLED=false');
    assertStringContains(result, 'GRAPHITI_ENABLED=false');
    assertStringNotContains(result, '# MCP servers disabled');

    console.log('âœ… Default project config test passed\n');
  })();

  // Test 3: Env generation with custom project config and settings
  (() => {
    console.log('Test 3: Env generation with custom project config and settings');
    const customConfig = {
      context7Enabled: false,
      linearMcpEnabled: true,
      electronMcpEnabled: true,
      puppeteerMcpEnabled: false,
      graphitiEnabled: true,
      linearApiKey: 'custom-linear-key',
      linearTeamId: 'team-123',
      githubToken: 'custom-github-token',
      githubRepo: 'owner/repo',
      customMcpServers: [
        {
          id: 'custom1',
          name: 'Custom Server 1',
          type: 'command' as const,
          command: 'custom-command',
          args: ['--arg1', '--arg2']
        },
        {
          id: 'custom2',
          name: 'Custom Server 2',
          type: 'http' as const,
          url: 'http://localhost:3000',
          headers: { 'Authorization': 'Bearer token' }
        }
      ],
      agentMcpOverrides: {
        coder: {
          add: ['custom1'],
          remove: ['context7']
        },
        planner: {
          add: ['custom2']
        }
      }
    };

    const settings = {
      anthropicApiKey: 'test-anthropic-key',
      graphitiApiKey: 'test-graphiti-key'
    };

    const result = generateAutoClaudeEnv({ projectConfig: customConfig, settings });

    assertStringContains(result, 'AUTO_CLAUDE_ENABLED=true');
    assertStringContains(result, 'ANTHROPIC_API_KEY=test-anthropic-key');
    assertStringContains(result, 'LINEAR_API_KEY=custom-linear-key');
    assertStringContains(result, 'LINEAR_TEAM_ID=team-123');
    assertStringContains(result, 'GITHUB_TOKEN=custom-github-token');
    assertStringContains(result, 'GITHUB_REPO=owner/repo');
    assertStringContains(result, 'GRAPHITI_API_KEY=test-graphiti-key');
    assertStringContains(result, 'CONTEXT7_ENABLED=false');
    assertStringContains(result, 'LINEAR_MCP_ENABLED=true');
    assertStringContains(result, 'ELECTRON_MCP_ENABLED=true');
    assertStringContains(result, 'PUPPETEER_MCP_ENABLED=false');
    assertStringContains(result, 'GRAPHITI_ENABLED=true');

    // Custom MCP servers
    assertStringContains(result, 'CUSTOM_MCP_CUSTOM1_TYPE=command');
    assertStringContains(result, 'CUSTOM_MCP_CUSTOM1_COMMAND=custom-command');
    assertStringContains(result, 'CUSTOM_MCP_CUSTOM1_ARGS=--arg1 --arg2');
    assertStringContains(result, 'CUSTOM_MCP_CUSTOM2_TYPE=http');
    assertStringContains(result, 'CUSTOM_MCP_CUSTOM2_URL=http://localhost:3000');
    assertStringContains(result, 'CUSTOM_MCP_CUSTOM2_HEADERS=Authorization:Bearer token');

    // Agent overrides
    assertStringContains(result, 'AGENT_CODER_MCP_ADD=custom1');
    assertStringContains(result, 'AGENT_CODER_MCP_REMOVE=context7');
    assertStringContains(result, 'AGENT_PLANNER_MCP_ADD=custom2');

    console.log('âœ… Custom project config and settings test passed\n');
  })();

  // Test 4: Settings override project config
  (() => {
    console.log('Test 4: Settings override project config');
    const projectConfig = {
      ...getDefaultAutoClaudeProjectConfig(),
      linearApiKey: 'project-linear-key',
      githubToken: 'project-github-token'
    };

    const settings = {
      linearApiKey: 'settings-linear-key',
      githubToken: 'settings-github-token'
    };

    const result = generateAutoClaudeEnv({ projectConfig, settings });

    assertStringContains(result, 'LINEAR_API_KEY=settings-linear-key');
    assertStringContains(result, 'GITHUB_TOKEN=settings-github-token');

    console.log('âœ… Settings override test passed\n');
  })();

  // Test 5: Validate valid env content
  (() => {
    console.log('Test 5: Validate valid env content');
    const validEnv = generateAutoClaudeEnv({
      projectConfig: getDefaultAutoClaudeProjectConfig(),
      settings: { anthropicApiKey: 'valid-key' }
    });

    const validation = validateAutoClaudeEnv(validEnv);
    assert(validation.valid, `Expected valid env but got errors: ${validation.errors.join(', ')}`);
    assert.strictEqual(validation.errors.length, 0);

    console.log('âœ… Valid env validation test passed\n');
  })();

  // Test 6: Validate invalid env content - missing ANTHROPIC_API_KEY
  (() => {
    console.log('Test 6: Validate invalid env - missing ANTHROPIC_API_KEY');
    const invalidEnv = `
AUTO_CLAUDE_ENABLED=true
CONTEXT7_ENABLED=true
ANTHROPIC_API_KEY=
`;

    const validation = validateAutoClaudeEnv(invalidEnv);
    assert(!validation.valid, 'Expected invalid env');
    assert(validation.errors.some(e => e.includes('ANTHROPIC_API_KEY is required')));

    console.log('âœ… Invalid env validation test passed\n');
  })();

  // Test 7: Validate invalid env - Linear enabled without API key
  (() => {
    console.log('Test 7: Validate invalid env - Linear enabled without API key');
    const invalidEnv = `
AUTO_CLAUDE_ENABLED=true
LINEAR_MCP_ENABLED=true
ANTHROPIC_API_KEY=valid-key
`;

    const validation = validateAutoClaudeEnv(invalidEnv);
    assert(!validation.valid, 'Expected invalid env');
    assert(validation.errors.some(e => e.includes('LINEAR_API_KEY is required')));

    console.log('âœ… Linear validation test passed\n');
  })();

  // Test 8: Validate invalid env - no MCP servers enabled
  (() => {
    console.log('Test 8: Validate invalid env - no MCP servers enabled');
    const invalidEnv = `
AUTO_CLAUDE_ENABLED=true
CONTEXT7_ENABLED=false
LINEAR_MCP_ENABLED=false
ELECTRON_MCP_ENABLED=false
PUPPETEER_MCP_ENABLED=false
GRAPHITI_ENABLED=false
ANTHROPIC_API_KEY=valid-key
`;

    const validation = validateAutoClaudeEnv(invalidEnv);
    assert(!validation.valid, 'Expected invalid env');
    assert(validation.errors.some(e => e.includes('At least one MCP server should be enabled')));

    console.log('âœ… MCP servers validation test passed\n');
  })();

  // Test 9: Test default config function
  (() => {
    console.log('Test 9: Test default config function');
    const defaultConfig = getDefaultAutoClaudeProjectConfig();

    assert.strictEqual(defaultConfig.context7Enabled, true);
    assert.strictEqual(defaultConfig.linearMcpEnabled, false);
    assert.strictEqual(defaultConfig.electronMcpEnabled, false);
    assert.strictEqual(defaultConfig.puppeteerMcpEnabled, false);
    assert.strictEqual(defaultConfig.graphitiEnabled, false);
    assert.deepStrictEqual(defaultConfig.customMcpServers, []);
    assert.deepStrictEqual(defaultConfig.agentMcpOverrides, {});

    console.log('âœ… Default config function test passed\n');
  })();

  // Test 10: Edge case - empty custom arrays
  (() => {
    console.log('Test 10: Edge case - empty custom arrays');
    const configWithEmptyArrays = {
      ...getDefaultAutoClaudeProjectConfig(),
      customMcpServers: [],
      agentMcpOverrides: {}
    };

    const result = generateAutoClaudeEnv({ projectConfig: configWithEmptyArrays });

    assertStringNotContains(result, '# === Custom MCP Servers ===');
    assertStringNotContains(result, '# === Agent MCP Overrides ===');

    console.log('âœ… Empty arrays edge case test passed\n');
  })();

  console.log('ðŸŽ‰ All env-file generator tests passed!\n');
}

// Run tests if this file is executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  runTests();
}

export { runTests as runEnvFileTests };