// =============================================================================
// CCM Simplified Schema - Smart Recommendations Core
// =============================================================================
//
// Philosophy: OBSERVE → ANALYZE → RECOMMEND → APPLY → MEASURE → AUTOMATE
//
// 12 models focused on intelligent optimization
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CORE: Machine & Project Identity
// =============================================================================

model Machine {
  id               String   @id @default(cuid())
  name             String   @unique
  hostname         String?
  platform         String   // "darwin", "linux", "win32"
  arch             String?  // "arm64", "x64"
  homeDir          String?
  lastSeen         DateTime @default(now())
  isCurrentMachine Boolean  @default(false)

  // Relationships
  projects          Project[]
  sessions          Session[]
  patterns          Pattern[]
  recommendations   Recommendation[]
  healthScores      HealthScore[]
  contextAnalyses   ContextAnalysis[]
  contextArchives   ContextArchive[]
  scheduledTasks    ScheduledTask[]
  appliedConfigs    AppliedConfig[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastSeen])
}

model Project {
  id        String   @id @default(cuid())
  name      String
  path      String
  machineId String

  // Detected info (auto-populated from sessions)
  detectedTechs    String?  // JSON: ["nextjs", "postgresql", "docker"]
  detectedPatterns String?  // JSON: ["database_queries", "git_workflow"]
  lastActiveAt     DateTime?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([path, machineId])
  @@index([machineId])
  @@index([lastActiveAt])
}

// =============================================================================
// OBSERVE: Session Tracking
// =============================================================================

model Session {
  id        String   @id @default(cuid())
  machineId String
  sessionId String   @unique // Claude Code session ID

  // Context
  projectPath String?
  projectName String?

  // Timing
  startedAt DateTime @default(now())
  endedAt   DateTime?
  duration  Int?     // seconds

  // What happened (JSON arrays)
  toolsUsed       String @default("[]") // ["Read", "Bash", "Edit", "Grep"]
  commandsRun     String @default("[]") // ["git status", "psql -h localhost"]
  filesAccessed   String @default("[]") // ["/src/index.ts", "/prisma/schema.prisma"]
  errors          String @default("[]") // ["ENOENT", "Connection refused"]

  // Token usage
  tokensUsed      Int @default(0)
  contextTokens   Int @default(0) // Tokens from CLAUDE.md etc.

  // Auto-detected (JSON arrays)
  detectedTechs    String @default("[]") // ["postgresql", "docker", "nextjs"]
  detectedPatterns String @default("[]") // ["ssh_database", "git_workflow"]

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([projectPath])
  @@index([startedAt])
}

// =============================================================================
// ANALYZE: Pattern Detection
// =============================================================================

model Pattern {
  id        String @id @default(cuid())
  machineId String
  type      String // "database_query", "git_workflow", "docker_ops", "api_calls"

  // Statistics
  occurrences  Int      @default(1)
  firstSeen    DateTime @default(now())
  lastSeen     DateTime @default(now())
  avgPerWeek   Float    @default(0)

  // Context (JSON)
  projectPaths   String @default("[]") // Projects where this pattern occurs
  technologies   String @default("[]") // Related technologies
  exampleCommand String? // Representative example

  // Analysis
  confidence       Float @default(1.0) // 0.0 to 1.0
  hasRecommendation Boolean @default(false)

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([machineId, type])
  @@index([machineId])
  @@index([occurrences])
}

// =============================================================================
// RECOMMEND: Smart Recommendations
// =============================================================================

// Unified recommendation model - handles MCP servers, skills, hooks, context, etc.
model Recommendation {
  id        String @id @default(cuid())
  machineId String

  // What type of recommendation
  category String // "mcp_server", "skill", "hook", "permission", "context", "workflow"

  // Human-readable
  title       String // "Enable PostgreSQL MCP Server"
  description String // "You've run 47 database queries via SSH..."
  priority    String // "critical", "high", "medium", "low"

  // Evidence (JSON)
  evidence String @default("{}") // { patterns: [...], occurrences: 47, projects: [...] }

  // Impact estimation
  estimatedTokenSavings Int @default(0) // per month
  estimatedTimeSavings  Int @default(0) // seconds per use
  confidenceScore       Float @default(0.8)

  // The actual config to apply (JSON)
  // For MCP: { command: "npx", args: [...], env: {...} }
  // For Hook: { type: "PreToolUse", matcher: "*", command: "..." }
  // For Skill: { name: "...", content: "..." }
  configType   String  // "mcp_server", "hook", "permission", "skill", "context_rule"
  configData   String  @default("{}") // JSON config to apply

  // Status
  status        String    @default("active") // "active", "applied", "dismissed", "expired"
  appliedAt     DateTime?
  dismissedAt   DateTime?
  dismissReason String?

  // Feedback loop
  wasHelpful    Boolean?
  actualSavings Int? // Measured after applying

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([machineId])
  @@index([status])
  @@index([priority])
  @@index([category])
}

// =============================================================================
// MEASURE: Health & Impact
// =============================================================================

model HealthScore {
  id        String @id @default(cuid())
  machineId String

  // Overall score (0-100)
  score Int

  // Category breakdown (0-100 each)
  mcpScore     Int // Are you using recommended MCP servers?
  contextScore Int // Is your CLAUDE.md optimized?
  patternScore Int // Are repetitive patterns automated?
  skillScore   Int // Are you using skills effectively?

  // Metrics
  activeRecommendations  Int @default(0)
  appliedRecommendations Int @default(0)
  dismissedRecommendations Int @default(0)

  // Trend
  previousScore Int?
  trend         String @default("stable") // "improving", "stable", "declining"

  // Token metrics
  estimatedMonthlyWaste   Int @default(0)
  estimatedMonthlySavings Int @default(0)

  machine   Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  timestamp DateTime @default(now())

  @@index([machineId])
  @@index([timestamp])
}

// =============================================================================
// CONTEXT: CLAUDE.md Optimization
// =============================================================================

model ContextAnalysis {
  id          String @id @default(cuid())
  machineId   String
  projectPath String
  filePath    String // Usually "CLAUDE.md"

  // Size metrics
  totalLines  Int
  totalTokens Int

  // Analysis results (JSON)
  sections String @default("[]") // [{ name: "...", lines: 50, tokens: 200, type: "active|historical" }]
  issues   String @default("[]") // [{ type: "bloat", severity: "high", description: "..." }]

  // Optimization potential
  currentScore     Int // 0-100
  potentialScore   Int // 0-100 after optimization
  estimatedSavings Int // tokens

  // Status
  status     String   @default("analyzed") // "analyzed", "optimized"
  analyzedAt DateTime @default(now())

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([machineId, projectPath, filePath])
  @@index([machineId])
  @@index([currentScore])
}

model ContextArchive {
  id          String @id @default(cuid())
  machineId   String
  projectPath String
  sourceFile  String // "CLAUDE.md"

  // What was archived
  sectionName    String
  reason         String // "completed_work", "outdated", "verbose"
  originalTokens Int
  summaryTokens  Int

  // Content
  archivedContent String // Full content moved to archive
  summaryContent  String // Condensed replacement (if any)

  // Metadata
  archivePath String   // ".claude/archives/2026-01-context.md"
  archivedAt  DateTime @default(now())

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([projectPath])
  @@index([archivedAt])
}

// =============================================================================
// AUTOMATE: Scheduled Tasks
// =============================================================================

model ScheduledTask {
  id        String  @id @default(cuid())
  machineId String?

  // Task definition
  name        String
  description String?
  taskType    String // "analyze_context", "generate_recommendations", "health_check"

  // Schedule
  scheduleType   String  // "cron", "interval", "threshold"
  cronExpression String? // "0 9 * * *"
  intervalHours  Int?    // 24 = daily

  // Threshold trigger (optional)
  thresholdMetric String? // "health_score", "context_tokens"
  thresholdValue  Int?
  thresholdOp     String? // "lt", "gt"

  // Config (JSON)
  taskConfig String @default("{}") // { strategy: "moderate", dryRun: false }

  // Status
  enabled   Boolean   @default(true)
  lastRunAt DateTime?
  nextRunAt DateTime?

  // Relationships
  machine    Machine?        @relation(fields: [machineId], references: [id], onDelete: Cascade)
  executions TaskExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([machineId])
  @@index([enabled])
  @@index([nextRunAt])
}

model TaskExecution {
  id     String  @id @default(cuid())
  taskId String

  // Execution
  status      String   @default("pending") // "pending", "running", "completed", "failed"
  triggerType String // "scheduled", "threshold", "manual"
  startedAt   DateTime @default(now())
  completedAt DateTime?
  durationMs  Int?

  // Results (JSON)
  result String? // { analyzed: 5, recommendations: 3, tokensSaved: 1200 }
  error  String?

  task ScheduledTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([status])
  @@index([startedAt])
}

// =============================================================================
// APPLIED CONFIGS: What's Currently Active
// =============================================================================

// Track what recommendations have been applied (the actual configs in use)
model AppliedConfig {
  id        String @id @default(cuid())
  machineId String

  // What type
  configType String // "mcp_server", "hook", "permission", "skill"
  configName String // "postgresql", "pre-commit-lint", etc.

  // The active configuration (JSON)
  configData String

  // Source
  recommendationId String? // Which recommendation led to this (if any)
  source           String  // "recommendation", "manual", "imported"

  // Status
  enabled   Boolean  @default(true)
  appliedAt DateTime @default(now())

  // Impact tracking
  usageCount    Int @default(0)
  lastUsedAt    DateTime?
  tokensSaved   Int @default(0)

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([machineId, configType, configName])
  @@index([machineId])
  @@index([configType])
  @@index([enabled])
}
