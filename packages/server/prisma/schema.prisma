// Prisma schema for CCM
// See docs/SPECIFICATION.md section 8 for full data model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Component types enum is handled via string field
// MCP_SERVER, SUBAGENT, SKILL, COMMAND, HOOK, CLAUDE_MD_TEMPLATE, AUTO_CLAUDE_AGENT_CONFIG, AUTO_CLAUDE_PROMPT, AUTO_CLAUDE_MODEL_PROFILE, AUTO_CLAUDE_PROJECT_CONFIG

model Component {
  id          String   @id @default(cuid())
  type        String   // ComponentType enum as string
  name        String
  description String
  config      String   // JSON stored as TEXT
  sourceUrl   String?
  version     String?
  tags        String   @default("")
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  profiles ProfileComponent[]

  @@unique([type, name])
}

model Profile {
  id               String   @id @default(cuid())
  name             String   @unique
  description      String
  claudeMdTemplate String?  // CLAUDE.md template content
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  components ProfileComponent[]
  projects   Project[]
}

model ProfileComponent {
  profileId   String
  componentId String
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  profile   Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@id([profileId, componentId])
}

model Project {
  id           String    @id @default(cuid())
  name         String
  path         String
  machine      String
  profileId    String?
  lastSyncedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Auto-Claude specific
  autoClaudeEnabled    Boolean   @default(false)
  autoClaudeConfigId   String?   // Link to AUTO_CLAUDE_PROJECT_CONFIG
  modelProfileId       String?   // Link to AUTO_CLAUDE_MODEL_PROFILE
  lastAutoClaudeSync   DateTime?

  profile Profile? @relation(fields: [profileId], references: [id], onDelete: SetNull)

  @@unique([path, machine])
}

model MonitoringEntry {
  id        String   @id @default(cuid())
  source    String   // e.g., "claude-code-changelog", "mcp-servers"
  title     String
  content   String   // Full content or summary
  url       String?
  severity  String   @default("info") // info, warning, important
  isRead    Boolean  @default(false)
  fetchedAt DateTime @default(now())
  createdAt DateTime @default(now())
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // JSON or plain text
  encrypted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// CCM v2.0 - Machine Registry
// ============================================================================

model Machine {
  id               String   @id @default(cuid())
  name             String   @unique
  hostname         String?
  platform         String   // "darwin", "linux", "win32"
  arch             String?  // "arm64", "x64"
  homeDir          String?  // For path resolution
  lastSeen         DateTime @default(now())
  lastSyncedAt     DateTime?
  syncEnabled      Boolean  @default(true)
  isCurrentMachine Boolean  @default(false)

  overrides MachineOverride[]
  syncLogs  SyncLog[]

  // v3.0 Smart Recommendations relationships
  sessionActivities SessionActivity[]
  usagePatterns     UsagePattern[]
  recommendations   Recommendation[]
  healthScores      HealthScore[]
  impactMetrics     ImpactMetric[]
  technologyUsage   TechnologyUsage[]

  // v3.1 Context Optimizer relationships
  contextAnalyses    ContextAnalysis[]
  contextArchives    ContextArchive[]
  optimizationRules  ContextOptimizationRule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastSeen])
  @@index([syncEnabled])
}

model MachineOverride {
  id           String   @id @default(cuid())
  machineId    String
  configType   String   // "mcp_server", "hook", "permission", "env_var", "plugin"
  configKey    String   // ID or name of the config being overridden
  action       String   // "include", "exclude", "modify"
  overrideData String?  // JSON override data if action is "modify"
  reason       String?  // Why this override exists

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([machineId, configType, configKey])
  @@index([machineId])
}

// ============================================================================
// CCM v2.0 - Global Hooks
// ============================================================================

model GlobalHook {
  id          String   @id @default(cuid())
  hookType    String   // "PreToolUse", "PostToolUse", "SessionStart", "Stop", "Notification", "SubagentStop"
  matcher     String   // Tool matcher pattern, e.g., "Edit|Write", "*"
  command     String   @default("") // Shell command to run (can be multi-line)
  timeout     Int?     // Timeout in seconds
  description String?
  enabled     Boolean  @default(true)
  order       Int      @default(0)
  category    String?  // For UI grouping: "git", "security", "formatting", "notifications"
  tags        String   @default("") // Comma-separated tags

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hookType])
  @@index([enabled])
  @@index([category])
}

// ============================================================================
// CCM v2.0 - Global Permissions
// ============================================================================

model GlobalPermission {
  id          String   @id @default(cuid())
  permission  String   // e.g., "Bash(git:*)", "WebFetch(domain:github.com)"
  action      String   // "allow" or "deny"
  description String?
  enabled     Boolean  @default(true)
  category    String?  // "git", "network", "shell", "file", "docker", "cloud"
  priority    Int      @default(0) // Higher = evaluated first

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([permission, action])
  @@index([action])
  @@index([category])
  @@index([enabled])
}

// ============================================================================
// CCM v2.0 - Global Environment Variables
// ============================================================================

model GlobalEnvVar {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   // Encrypted for sensitive values
  encrypted   Boolean  @default(false)
  sensitive   Boolean  @default(false) // Mask in UI even if not encrypted
  description String?
  scope       String   @default("all") // "all", "claude-desktop", "claude-code", "cli"
  category    String?  // "api_keys", "paths", "webhooks", "database"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scope])
  @@index([category])
}

// ============================================================================
// CCM v2.0 - Claude Desktop Configuration
// ============================================================================

model ClaudeDesktopMcp {
  id              String   @id @default(cuid())
  componentId     String   // Reference to Component with type MCP_SERVER
  enabled         Boolean  @default(true)

  // Desktop-specific overrides (JSON)
  commandOverride String?  // Override command for desktop
  argsOverride    String?  // Override args for desktop (JSON array)
  envOverrides    String?  // Additional/override env vars (JSON object)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([componentId])
  @@index([enabled])
}

model ClaudeDesktopPlugin {
  id       String   @id @default(cuid())
  pluginId String   // e.g., "frontend-design@claude-plugins-official"
  enabled  Boolean  @default(true)
  config   String?  // Plugin-specific config (JSON)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pluginId])
}

// ============================================================================
// CCM v2.0 - Sync System
// ============================================================================

model SyncLog {
  id           String    @id @default(cuid())
  machineId    String
  syncType     String    // "full", "incremental", "push", "pull"
  status       String    // "started", "in_progress", "completed", "failed"

  // Stats
  filesCreated Int @default(0)
  filesUpdated Int @default(0)
  filesDeleted Int @default(0)
  filesSkipped Int @default(0)

  // Details
  details      String?  // JSON with detailed sync info
  errorMessage String?

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([status])
  @@index([startedAt])
}

model SyncState {
  id           String    @id @default(cuid())
  machineId    String
  configType   String    // "hook", "permission", "mcp_server", "agent", etc.
  configId     String    // ID of the config item
  localHash    String?   // Hash of local file content
  serverHash   String?   // Hash of server content
  lastSyncedAt DateTime?
  syncStatus   String    @default("unknown") // "synced", "local_newer", "server_newer", "conflict"

  @@unique([machineId, configType, configId])
  @@index([syncStatus])
  @@index([machineId])
}

// ============================================================================
// CCM v3.0 - Smart Recommendations System
// ============================================================================

// Session activity tracking - captures every Claude Code session
model SessionActivity {
  id              String   @id @default(cuid())
  machineId       String
  projectId       String?
  sessionId       String   // Unique per Claude Code session

  // Basic metadata
  projectPath     String?
  duration        Int      // Seconds
  timestamp       DateTime @default(now())

  // Tools used (JSON array)
  toolsUsed       String   // ["Read", "Bash", "Edit", "Grep", ...]

  // Commands executed (JSON array)
  commandsRun     String   // ["git status", "psql -h ...", ...]

  // Files accessed (JSON array)
  filesAccessed   String   // ["/path/to/file1.ts", "/path/to/file2.sql", ...]

  // Errors encountered (JSON array)
  errors          String   // ["ENOENT", "Connection refused", ...]

  // Token usage
  startupTokens   Int      // Tokens at session start
  totalTokens     Int      // Total tokens used
  toolTokens      Int      // Tokens from tool use
  contextTokens   Int      // Tokens from context

  // Detected technologies (JSON array)
  detectedTechs   String   // ["postgresql", "n8n", "docker", "nextjs", ...]

  // Patterns detected (JSON array)
  detectedPatterns String  // ["ssh_database_query", "git_workflow", ...]

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([projectId])
  @@index([timestamp])
  @@index([sessionId])
}

// Aggregated usage patterns (computed from SessionActivity)
model UsagePattern {
  id              String   @id @default(cuid())
  machineId       String
  patternType     String   // "ssh_database_query", "git_workflow", etc.

  // Occurrence statistics
  occurrences     Int      @default(0)
  lastSeen        DateTime
  firstSeen       DateTime
  avgFrequency    Float    // Occurrences per week

  // Context
  projectIds      String   // JSON array of project IDs where seen
  technologies    String   // JSON array of related technologies

  // Examples (for UI display)
  exampleCommand  String?
  exampleFiles    String?  // JSON array

  // Pattern confidence
  confidence      Float    @default(1.0) // 0.0 to 1.0

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([machineId, patternType])
  @@index([machineId])
  @@index([occurrences])
  @@index([confidence])
}

// Smart recommendations
model Recommendation {
  id              String   @id @default(cuid())
  machineId       String
  type            String   // "mcp_server" or "skill"

  // What to recommend
  recommendedItem String   // Name of MCP server or skill
  category        String   // "database", "cicd", "automation", etc.

  // Why recommend (human-readable)
  title           String   // Short title
  reason          String   // Detailed explanation

  // Evidence
  detectedPatterns String  // JSON array of pattern types
  occurrenceCount Int      // How many times pattern seen
  projectsAffected String  // JSON array of project IDs
  exampleUsage    String?  // Example of the pattern

  // Impact estimation
  timeSavings     Int      // Seconds saved per use
  tokenSavings    Int      // Tokens saved per use
  dailySavings    Int      // Estimated daily savings
  monthlySavings  Int      // Estimated monthly savings

  // Confidence & priority
  confidenceScore Float    // 0.0 to 1.0
  priority        String   // "critical", "high", "medium", "low"

  // Status tracking
  status          String   @default("active") // "active", "applied", "dismissed", "archived"
  appliedAt       DateTime?
  dismissedAt     DateTime?
  dismissReason   String?  // Why user dismissed

  // Configuration to apply
  configTemplate  String?  // JSON config

  // Feedback (for learning)
  wasUseful       Boolean? // User feedback after applying
  actualSavings   Int?     // Measured savings after applying

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([machineId, recommendedItem])
  @@index([machineId])
  @@index([status])
  @@index([priority])
  @@index([confidenceScore])
}

// Health score tracking
model HealthScore {
  id              String   @id @default(cuid())
  machineId       String

  // Overall score (0-100)
  totalScore      Int

  // Category scores (0-100)
  mcpScore        Int      // MCP server optimization
  skillScore      Int      // Skill utilization
  contextScore    Int      // Context efficiency
  patternScore    Int      // Pattern optimization

  // Metrics
  activeRecommendations  Int  // Open recommendations
  appliedRecommendations Int  // Applied recommendations
  estimatedDailyWaste    Int  // Tokens wasted per day
  estimatedDailySavings  Int  // Tokens saved per day (after optimizations)

  // Trend
  previousScore   Int?     // Score from last calculation
  trend           String   // "improving", "stable", "declining"

  timestamp       DateTime @default(now())
  machine         Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([timestamp])
}

// Impact tracking (measures actual results)
model ImpactMetric {
  id              String   @id @default(cuid())
  machineId       String
  recommendationId String?
  metricType      String   // "token_savings", "time_savings", "pattern_reduction"

  // Before/after comparison
  beforeValue     Int
  afterValue      Int
  improvement     Float    // Percentage improvement

  // Time period
  measurementStart DateTime
  measurementEnd   DateTime

  timestamp       DateTime @default(now())
  machine         Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([recommendationId])
  @@index([timestamp])
}

// Technology usage tracking
model TechnologyUsage {
  id              String   @id @default(cuid())
  machineId       String
  technology      String   // "postgresql", "docker", "n8n", etc.

  // Usage stats
  projectCount    Int      @default(0)  // Projects using this
  sessionCount    Int      @default(0)  // Sessions using this
  commandCount    Int      @default(0)  // Commands related to this
  lastUsed        DateTime?

  // Recommendations
  hasRecommendation Boolean @default(false)
  recommendationId  String?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([machineId, technology])
  @@index([machineId])
  @@index([sessionCount])
}

// ============================================================================
// CCM v3.1 - Context Optimizer
// ============================================================================

// Context analysis results
model ContextAnalysis {
  id              String   @id @default(cuid())
  machineId       String
  projectPath     String
  filePath        String   // Path to CLAUDE.md or other context file

  // Analysis results
  totalLines      Int
  totalTokens     Int      // Estimated token count

  // Section breakdown (JSON)
  sections        String   // Array of detected sections with metadata

  // Issues detected (JSON)
  issues          String   // Array of optimization opportunities

  // Recommendations
  estimatedSavings    Int  // Tokens that could be saved
  optimizationScore   Int  // 0-100, higher = more optimized

  // Status
  status          String   @default("analyzed") // "analyzed", "optimized", "archived"
  lastAnalyzedAt  DateTime @default(now())

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([machineId, projectPath, filePath])
  @@index([machineId])
  @@index([optimizationScore])
}

// Archived content from context files
model ContextArchive {
  id              String   @id @default(cuid())
  machineId       String
  projectPath     String
  sourceFile      String   // Original file (e.g., "CLAUDE.md")
  archiveFile     String   // Archive path (e.g., ".claude/archives/CLAUDE-2026-01.md")

  // What was archived
  sectionName     String   // e.g., "Completed Work Sessions"
  originalLines   Int
  originalTokens  Int
  summaryLines    Int      // Lines in condensed summary

  // Content
  archivedContent String   // Full archived content
  summaryContent  String   // Condensed replacement

  // Metadata
  archiveReason   String   // "completed_work", "outdated", "verbose", "duplicate"
  archivedAt      DateTime @default(now())

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([machineId])
  @@index([projectPath])
  @@index([archivedAt])
}

// Optimization rules (user-configurable)
model ContextOptimizationRule {
  id              String   @id @default(cuid())
  machineId       String?  // null = global rule

  // Rule definition
  name            String
  description     String?
  ruleType        String   // "archive", "condense", "remove", "move"

  // Pattern matching
  sectionPattern  String?  // Regex to match section headers
  contentPattern  String?  // Regex to match content
  ageThreshold    Int?     // Days old before applying
  lineThreshold   Int?     // Min lines before applying

  // Action
  action          String   // JSON action configuration

  enabled         Boolean  @default(true)
  priority        Int      @default(0)

  machine Machine? @relation(fields: [machineId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([machineId])
  @@index([ruleType])
  @@index([enabled])
}
